<!DOCTYPE HTML>
<html>
  <head>
    <title>工作计划</title>
    <meta charset="utf-8">
    <link href="/awater/css/style.min862f.css?v=4.1.0" rel="stylesheet">
	<link href="/awater/css/bootstrap.min14ed.css?v=3.3.6" rel="stylesheet">
    <link href="/awater/lib/plugins/malihu-custom-scrollbar-plugin-master/jquery.mCustomScrollbar.css" rel="stylesheet">
    <link href="/awater/css/augur.expand.css" rel="stylesheet" type="text/css" />    
    <link href="/awater/lib/plugins/datetimepicker/css/bootstrap-datetimepicker.css" rel="stylesheet">
	<link href="/awater/lib/zTree/css/zTreeStyle/metro.css" type="text/css" rel="stylesheet" >
    <link href="/awater/css/plugins/bootstrapvalidator/bootstrapValidator.css" rel="stylesheet">
  
    <script src="/awater/js/util_date.js" type="text/javascript"></script>
    <script src="/awater/lib/jquery-2.1.4.js?v=2.1.4"></script>
    <script src="/awater/lib/bootstrap.min.js?v=3.3.6"></script>
    <script src="/awater/lib/plugins/datetimepicker/js/bootstrap-datetimepicker.js"></script>
    <script src="/awater/lib/plugins/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script> 
    <script src="/awater/js/util_date.js" type="text/javascript"></script>
    <script src="/awater/lib/plugins/malihu-custom-scrollbar-plugin-master/js/minified/jquery.mousewheel.min.js"></script >
	<script src="/awater/lib/plugins/malihu-custom-scrollbar-plugin-master/js/minified/jquery.mCustomScrollbar.min.js"></script>
	<script src="/awater/lib/zTree/js/jquery.ztree.all.js" type="text/javascript"></script>
	<script src="/awater/lib/plugins/bootstrapvalidator/bootstrapValidator.js"></script> 
    <script src="/awater/lib/plugins/bootstrapvalidator/language/zh_CN.js"></script> 
	<style>
	  .form-group:after{
	     clear:none !important;
	  } 
	  .form-horizontal .form-group{
	    margin:5px 10px;
	    float: left;
	    padding-bottom: 10px;
	  }  
	  .control-label{
	     width:120px;
	     padding:0px 5px;
	     float:left;
	  }
	  .workGroup {width:45%;float:left;}
	  .workDiv {width:65%;float:left;padding-left:10px;}
	</style>
    <script type="text/javascript">
    	(function($){
	        $(window).load(function(){
	            $('#form').bootstrapValidator();
	            
    			$("#content").mCustomScrollbar();
    			
    			$("#planStartTime").datetimepicker({
					language: 'zh-CN',
				    minView:'month',
					format: 'yyyy-mm-dd',
					autoclose:true,
					pickerPosition:'bottom-right'
				});
				
				$("#planCompletionTime").datetimepicker({
					language: 'zh-CN',
					minView:'month',
					format: 'yyyy-mm-dd',
					autoclose:true,
					pickerPosition:'bottom-right'
				});
				
				$("#completedTime").datetimepicker({
					language: 'zh-CN',
				    minView:'month',
					format: 'yyyy-mm-dd',
					autoclose:true,
					pickerPosition:'bottom-right'
				});
    		});
    	})(jQuery);
    </script>
  </head>
  
  <body style="width: 100%">
	<div id="content" style="height:calc( 100% - 50px );">
	    <form id="form" class="form-horizontal" >
	        <div style="padding:12px 20px 0px 0px">
		        <input type="hidden" id="id" name="id" >
				<div class="form-group">
				      <label class="control-label">任务类型</label>
					  <div style="width:230px;float:left;padding-left:10px;">
						 <select class="form-control" id="missionNature" name="missionNature" required>
						    <option selected="selected"></option>
						    <option>道路路面维修</option>
						    <option>雨水管道清淤、疏通</option>
						    <option>桥梁（涵）维修</option>
						    <option>城市家具维修</option>
						 </select>
			          </div>
			          <div style="float:left;padding-left:20px">
			            <button class="btn btn-primary" type="button" onclick="addType()">添加类型</button>	
			         </div>
			    </div>
				 <div class="form-group workGroup">
                      <label class="control-label">任务名称</label>
					  <div class="workDiv">
						 <input class="form-control" type="text" id="missionName" name="missionName">
			          </div>
			    </div>	
				<div class="form-group workGroup">
				    <label class="control-label">计划种类</label>
					<div class="workDiv">
						<select class="form-control" id="missionType" name="missionType" required>
						    <option selected="selected"></option>
						    <option value='0'>年度计划</option>
						    <option value='1'>临时性计划</option>
						</select>						
					</div>
				</div>						
				<div class="form-group workGroup">
					<label class="control-label">任务开始时间</label>
					<div class="workDiv">
						<input class="form-control" type="text" id="planStartTime" name="planStartTime">
					</div>
				</div>	
			    <div class="form-group workGroup">
					<label class="control-label">计划结束时间</label>
					<div class="workDiv">
						<input class="form-control" id="planCompletionTime" name=planCompletionTime>
					</div>
				</div>											
				<div class="form-group workGroup">
					<label class="control-label">实际结束时间</label>
					<div class="workDiv">
						<input id="completedTime" name="completedTime" class="form-control">
					</div>
				</div>	
				<div class="form-group workGroup">
					<label class="control-label">任务年份</label>
					<div class="workDiv">
						<input class="form-control" id="missionYear" name="missionYear" required>
					</div>
				</div>
				<div class="form-group workGroup">
					<label class="control-label">执行单位</label>
					<div class="workDiv">
						<select class="form-control" id="runUnit" name="runUnit" required>
						    <option selected="selected"></option>
					        <option value='0'>道路维护所</option>
				            <option value='1'>排水维护所</option>
				            <option value='2'>人行道维护所</option>
			                <option value='3'>桥涵维护所</option>
		                    <option value='4'>设备维护所</option>
						</select>	
					</div>
				</div>	
			    <div class="form-group workGroup">
				    <label class="control-label">状态</label>
					<div class="workDiv">
						<select class="form-control" id="status" name="status">
						    <option selected="selected"></option>
						    <option value='0'>未开始</option>
						    <option value='1'>完成中</option>
				            <option value='2'>已结束</option>
						</select>		
					</div>				
				</div>
				<div class="form-group workGroup">
			    	 <label class="control-label">维修路名</label>
					 <div class="workDiv">
						 <input class="form-control" type="text" id="roadName" name="roadName">
					 </div>
				</div>
				<div class="form-group workGroup">
				      <label class="control-label">计划维修路段</label>		
					  <div class="workDiv">
						 <input class="form-control" type="text" id="roadSection" name="roadSection">
			          </div>
			    </div>
				<div class="form-group" style="width:100%">
				    <label class="control-label">维修内容</label>
				    <div style="float:left;padding-left:10px;width: 600px;">
					   <textarea class="form-control" id="missionContent" name="missionContent" rows="3"></textarea>				
				    </div>
				</div>		
			</div>
		</form>
	</div>
	<div style="width:100%;height:50px;padding-top:10px;border-top:1px solid #e7eaec;background-color: #F8F8F8;">
		<div class="col-sm-9 col-sm-offset-9">
			<button class="btn btn-primary" type="button" onclick="save()">保存内容</button>
			<button class="btn btn-white" type="button" onclick="cancel()">取消</button>
		</div>
	</div>
	<script type="text/javascript">
	 	//数据填充	    
		function getQueryStr(name) {
			var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
			var r = decodeURI(window.location.search).substr(1).match(reg);
			if (r != null) 
				return unescape(r[2]);
			return "";
		}
	    var id=getQueryStr("id");
	    
	    $(function(){
       	   $.ajax({
				method : 'GET',
				url : location.protocol+"//"+location.hostname+":"+location.port+'/agsupport/sz-workplan!getTypes.action',
				async : true,
				dataType : 'json',
				success : function(data) {	
				   if(data.result.length==0)
				      return;
				   var result=data.result;
				   for(var i in result){
				      if($("#missionNature option:contains('"+result[i].MISSION_NATURE+"')").length>0)
				        continue;
				      else{
				        $("#missionNature").append("<option>"+result[i].MISSION_NATURE+"</option>");
				      }   
				   }
				   if(id!=""){
					    $.ajax({
							method : 'GET',
							url : location.protocol+"//"+location.hostname+":"+location.port+'/agsupport/sz-workplan!listJson.action?id='+id,
							async : true,
							dataType : 'json',
							success : function(data) {
								for (var key in data.rows[0]){
									if(key.toLowerCase().indexOf("gender")!=-1){
									   if(data.rows[0][key]=="0")
										  $("#"+key).val(0);
										else if(data.rows[0][key]=="1")
										  $("#"+key).val(1);
									} 
									else if(key.toLowerCase().indexOf("run")!=-1){
									   if(data.rows[0][key]=="0")
										  $("#"+key).val(0);
										else if(data.rows[0][key]=="1")
										  $("#"+key).val(1);
										 else if(data.rows[0][key]=="2")
										  $("#"+key).val(2);
										else if(data.rows[0][key]=="3")
										  $("#"+key).val(3);
										 else if(data.rows[0][key]=="4")
										  $("#"+key).val(4);							
									}
									else if(key.toLowerCase().indexOf("status")!=-1){
									   if(data.rows[0][key]=="0")
										  $("#"+key).val(0);
										else if(data.rows[0][key]=="1")
										  $("#"+key).val(1);
										  else if(data.rows[0][key]=="2")
										  $("#"+key).val(2);							
									}
									else if(key.toLowerCase().indexOf("time")!=-1&&data.rows[0][key]!=null)
										$("#"+key).val(getLocalDate(data.rows[0][key].time));
									else{
									   	$("#"+key).val(data.rows[0][key]);
								    }
								}
							},
							error : function() {
								alert('error');
							}
						});
					}
				},
				error : function() {
					alert('error');
				}
			});				

	    });
	    
		function save(){ 
		    $('#form').data('bootstrapValidator').validate();
			var validStatus=$('#form').data('bootstrapValidator').isValid();
			if(validStatus==true){
				var dataparam = getStrParamByArray($("#form").serializeArray());
				$.ajax({
					type: 'post',
					url : '/agsupport/sz-workplan!saveJson.action',
					data: dataparam,
					dataType : 'json',  
					success : function(data) {
						parent.layer.msg(data.result);
						var index = parent.layer.getFrameIndex(window.name);
						window.parent.closeLayer(index);
					},
					error : function() {
						alert('error');
					}
				});
			} else {
				parent.layer.msg("表单验证失败，请检查表单内容");
			}
		}
		
		function getStrParamByArray(array){
			var param="";
			for (pitem in array){
				if(param!=""){
					if(array[pitem].name.toLowerCase().indexOf("time")!=-1&&array[pitem].value!=""){
						param+="&"+array[pitem].name+"="+getTimeLong(array[pitem].value);
					}else
						param+="&"+array[pitem].name+"="+encodeURIComponent(array[pitem].value);
				}else{
					if(array[pitem].name.toLowerCase().indexOf("time")!=-1&&array[pitem].value!=""){
						param=array[pitem].name+"="+getTimeLong(array[pitem].value);
					}else
						param=array[pitem].name+"="+encodeURIComponent(array[pitem].value);
				}
			}
			return param;			
		}
		
		function cancel()
		{
		   parent.layer.close(parent.layer.getFrameIndex(window.name));
		}
		
		function addType(){
		    parent.layer.prompt({title: '请输入任务类型'}, function(value, index, elem){
				$("#missionNature").append("<option selected='selected'>"+value+"</option>");
				parent.layer.close(index); 
			});
		}
	</script>  
  </body>
</html>
