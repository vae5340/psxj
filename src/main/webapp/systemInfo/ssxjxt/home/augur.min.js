//全局变量
var baseUrl = location.protocol + "//" + location.hostname + ":" + location.port;
var dataIndex = 0;
var layerObjects = [];

//弹出窗默认元素左边缘、上边缘
var defaultLeft = 75;
var defaultTop = 120;
var userCode;
var userName;
var appId;
var menuList;

var userList;
//菜单json字符串格式
var menuListJson = [

    {"id": "M_巡查养护", "name": "巡查养护", "className": "zxjc", "pid": ""},
    {"id": "M_工程信息", "name": "工程管理", "className": "flyj", "pid": ""},
    {"id": "M_在线监控", "name": "在线监控", "className": "zxjc", "pid": ""},
    {"id": "M_综合考评", "name": "综合考评", "className": "flyj", "pid": ""},
    {"id": "M_MunicipalMrg", "name": "设施管理", "className": "flyj", "pid": ""},
    {"id": "M_MunicipalMaintenance", "name": "市政构建", "className": "szwh", "pid": ""},

    {
        "id": "F_TemplatedescList",
        "className": "leftmenu-mubanmiaoshu",
        "invoke": "",
        "link": "webpage/municipalbuild/templatedesc/templatedesc-list.html",
        "name": "数据模板描述",
        "pid": "M_FacilityBaseDatamanage"
    },
    {
        "id": "F_Metadatacategory",
        "className": "leftmenu-fenleiguanli",
        "invoke": "",
        "link": "webpage/municipalbuild/metadatacategory/metadatacategory.html",
        "name": "设施分类管理",
        "pid": "M_FacilityBaseDatamanage"
    },
    {
        "id": "F_Metatemplateclass",
        "className": "leftmenu-mubanguanli",
        "invoke": "",
        "link": "webpage/municipalbuild/metatemplateclass/metatemplateclass.html",
        "name": "基类模板管理",
        "pid": "M_FacilityBaseDatamanage"
    },
    {
        "id": "F_Metadatatable",
        "className": "leftmenu-jiegouguanli",
        "invoke": "",
        "link": "webpage/municipalbuild/metadatatable/metadatatable.html",
        "name": "模板结构管理",
        "pid": "M_FacilityBaseDatamanage"
    },
    {
        "id": "F_Metadictionary",
        "className": "leftmenu-zidianguanli",
        "invoke": "",
        "link": "webpage/municipalbuild/metadictionary/metadictionary.html",
        "name": "数据字典管理",
        "pid": "M_FacilityBaseDatamanage"
    },
    {
        "id": "F_Formpageconfiguration",
        "className": "leftmenu-yemianpeizhi",
        "invoke": "",
        "link": "webpage/municipalbuild/formpageconfiguration/formpageconfiguration.html?serverName=agsupport_asi",
        "name": "表单页面配置",
        "pid": "M_FacilityBaseDatamanage"
    },
    {
        "id": "M_FacilityBaseDatamanage",
        "name": "设施配置",
        "className": "fa fa-ssgl fa-all",
        "pid": "M_MunicipalMaintenance"
    },

    {
        "id": "F_RoadRoadList",
        "className": "leftmenu-list",
        "invoke": "",
        "link": "bootstrapDataGrid.html",
        "name": "设施列表",
        "pid": "M_Road"
    },
    {
        "id": "F_RoadStat",
        "className": "leftmenu-stat",
        "invoke": "panel",
        "link": "webpage/pipe/query/roadQuery/roadQuery.jsp	",
        "name": "设施统计",
        "pid": "M_Road"
    },
    {"id": "M_Road", "name": "道路", "className": "fa fa-road fa-all", "pid": "M_MunicipalMrg"},
    {
        "id": "F_BdgRoadList",
        "className": "leftmenu-list",
        "invoke": "",
        "link": "bootstrapDataGrid.html",
        "name": "设施列表",
        "pid": "M_Bdg"
    },
    {
        "id": "F_BdgStat",
        "className": "leftmenu-stat",
        "invoke": "panel",
        "link": "webpage/xcyh/statistics/patrol-report-stat.html?serverName=agsupport_asi",
        "name": "设施统计",
        "pid": "M_Bdg"
    },
    {"id": "M_Bdg", "name": "桥梁", "className": "fa fa-bdg fa-all", "pid": "M_MunicipalMrg"},
    {
        "id": "F_LightRoadList",
        "className": "leftmenu-list",
        "invoke": "",
        "link": "bootstrapDataGrid.html",
        "name": "设施列表",
        "pid": "M_Light"
    },
    {
        "id": "F_LightStat",
        "className": "leftmenu-stat",
        "invoke": "panel",
        "link": "webpage/xcyh/statistics/patrol-report-stat.html?serverName=agsupport_asi",
        "name": "设施统计",
        "pid": "M_Light"
    },
    {"id": "M_Light", "name": "照明", "className": "fa fa-light fa-all", "pid": "M_MunicipalMrg"}
];
$(function () {
    initMap();
    loadUserInfo();
    //从后台加载菜单，true表示匹配前台，false直接从后台读取菜单
    loadMenuFromService(false);
});

//加载系统用户信息
function loadUserInfo() {
    $.ajax({
        url: baseUrl + '/' + serverName + '/system-menu!getDisplayPlatformUserInfo.action',
        type: 'post',
        data: {},
        dataType: 'json',
        success: function (ajaxResult) {
            userList = JSON.parse(ajaxResult.result);
            //初始化系统用户名称
            $("#userName").text(userList[0].userName);
            userCode = userList[0].loginName;
            userName = userList[0].userName;
        }
    });
}

//从后台加载菜单，true表示匹配前台，false直接从后台读取菜单
function loadMenuFromService(isPick) {
    if (!isPick) {
        $.ajax({
            url: baseUrl + '/' + serverName + '/system-menu!getDisplayPlatformMenuInfo.action',
            type: 'get',
            data: {},
            dataType: 'json',
            success: function (ajaxResult) {
                menuList = JSON.parse(ajaxResult.result);
                //初始化一级菜单
                showFirstMenuList();
            }
        });
    } else {
        menuList = menuListJson;
        showFirstMenuList();
    }
}


//重新加载js文件
function loadJs(file) {
    var head = $("head").remove("script[role='reload']");
    $("<scri" + "pt>" + "</scr" + "ipt>").attr({role: 'reload', src: file, type: 'text/javascript'}).appendTo(head);
}

//显示一级菜单
function showFirstMenuList() {
    menuLen = menuList.length;
    var menuStr = "";
    for (var i = 0; i < menuLen; i++) {
        if (menuList[i].pid == 0) {
            if (menuList[i].isLeaf == "0") {
                //根据菜单JSON格式进行迭代循环 class='hover'
                menuStr += "<li><a onclick='showSecondMenu(\"" + menuList[i].id + "\")' href='#'>" +
                    "<div class='" + menuList[i].className + "'style='width: 45px;height:45px;'></div>" +
                    "<span>" + menuList[i].name + "</span></a></li>";
                if (menuList[i].id == 1) {
                    //默认显示
                    //一级菜单：第一个子系统
                    //二级菜单：第一个菜单
                    showSecondMenu(menuList[i].id);
                }
            } else if (menuList[i].isLeaf == "1") {
                if (menuList[i].link != '' && menuList[i].invoke != '') {
                    menuStr += "<li><a onclick='showThirdMenu(\"" + menuList[i].name + "\",\"" + menuList[i].link + getParams(menuList[i].link) + "\",\"" + menuList[i].hidden + "\")' href='#'>" +
                        "<div class='" + menuList[i].className + "'style='width: 45px;height:45px;'></div>" +
                        "<span>" + menuList[i].name + "</span></a></li>";
                } else if (menuList[i].link != '') {
                    menuStr += "<li><a class='J_menuItem' href='" + menuList[i].link + getParams(menuList[i].link) + "' data-index=" + dataIndex + ">" +
                        "<div class='" + menuList[i].className + "'style='width: 45px;height:45px;'></div>" +
                        "<span>" + menuList[i].name + "</span></a></li>";
                    dataIndex++;
                }
            }
        }
    }
    $("#topMenu").html(menuStr);
    loadJs("webpage/home/contabs.min.js");
    $("#topMenu>li").on('click', function () {
        $(this).addClass("tnav_def").siblings().removeClass("tnav_def");//给一级菜单去除默认样式
    });
}

//显示左侧二级菜单
function showSecondMenu(menuId, o) {
    //一级菜单点击后的样式
    $(o).parent().addClass("hover").siblings().removeClass("hover");
    //清空二级菜单
    $("#leftMenu").empty();
    //定义变量
    var secondMenuStr = "";
    var thirdMenuStr = "";
    for (var j = 0; j < menuLen; j++) {
        if (menuList[j].pid == menuId) {
            if (menuList[j].isLeaf == "0") {
                secondMenuStr += "<li id='" + menuList[j].id + "'><a style='padding:10px 5px 5px;text-align:center'>" +
                    "<i class='" + menuList[j].className + "'></i><span class='nav-label'></span><span class='fa arrow'></span>" +
                    "<div style='text-align:center; padding:5px 5px;text-decoration:none;cursor:pointer;'>" + menuList[j].name + "</div></a></li>";
                //默认显示
                //加载三级菜单
                for (var i = 0; i < menuLen; i++) {
                    if (menuList[i].pid == menuList[j].id) {
                        //var event=menuList[i].link==''?menuList[i].link:menuList[i].invoke;
                        if (menuList[i].invoke == 'jsExecute') {
                            thirdMenuStr += "<li class='" + menuList[i].pid + "'><a  onclick='" + menuList[i].link + "' data-index=" + dataIndex + ">" +
                                "<div class='" + menuList[i].className + "'style='width: 18px;height:18px;margin-left: 12px;'></div>" +
                                "<span style='width: 60px !important;margin-left: 30px;'>" + menuList[i].name + "</span></a></li>";
                        } else if (menuList[i].link != '' && menuList[i].invoke != '') {
                            thirdMenuStr += "<li class='" + menuList[i].pid + "'><a class='J_menuItem' onclick='showThirdMenu(\"" + menuList[i].name + "\",\"" + menuList[i].link + getParams(menuList[i].link) + "\",\"" + menuList[i].hidden + "\")' data-index=" + dataIndex + ">" +
                                "<div class='" + menuList[i].className + "'style='width: 18px;height:18px;margin-left: 12px;'></div>" +
                                "<span style='width: 60px !important;margin-left: 30px;'>" + menuList[i].name + "</span></a></li>";
                        } else if (menuList[i].link != '') {
                            thirdMenuStr += "<li class='" + menuList[i].pid + "'><a class='J_menuItem' href='" + menuList[i].link + getParams(menuList[i].link) + "' data-index=" + dataIndex + ">" +
                                "<div class='" + menuList[i].className + "'style='width: 18px;height:18px;margin-left: 12px;'></div>" +
                                "<span style='width: 60px !important;margin-left: 30px;'>" + menuList[i].name + "</span></a></li>";
                        }
                        dataIndex++;
                    }
                }
            } else if (menuList[j].isLeaf == "1") {
                if (menuList[i].invoke == 'jsExecute') {
                    thirdMenuStr += "<li class='" + menuList[i].pid + "'><a  onclick='" + menuList[i].link + "' data-index=" + dataIndex + ">" +
                    "<div class='" + menuList[i].className + "'style='width: 18px;height:18px;margin-left: 12px;'></div>" +
                    "<span style='width: 60px !important;margin-left: 30px;'>" + menuList[i].name + "</span></a></li>";
                }else if (menuList[j].link != '' && menuList[j].invoke != '') {
                    secondMenuStr += "<li id='" + menuList[j].id + "'><a style='padding:10px 5px 5px;text-align:center' onclick='showThirdMenu(\"" + menuList[j].name + "\",\"" + menuList[j].link + getParams(menuList[j].link) + "\",\"" + menuList[j].hidden + "\")' href='#'>" +
                        "<i class='" + menuList[j].className + "'></i><span class='nav-label'></span><span class='fa arrow'></span>" +
                        "<div style='text-align:center; padding:5px 5px;text-decoration:none;cursor:pointer;'>" + menuList[j].name + "</div></a></li>";
                } else if (menuList[j].link != '') {
                    secondMenuStr += "<li id='" + menuList[j].id + "'><a class='J_menuItem' href='" + menuList[j].link + getParams(menuList[j].link) + "' data-index=" + dataIndex + " style='padding:10px 5px 5px;text-align:center'>" +
                        "<i class='" + menuList[j].className + "'></i><span class='nav-label'></span><span class='fa arrow'></span>" +
                        "<div style='text-align:center; padding:5px 5px;text-decoration:none;cursor:pointer;'>" + menuList[j].name + "</div></a></li>";
                    dataIndex++;
                }
            }

        }
    }
    $("#thirdMenu").html(thirdMenuStr);
    $("#leftMenu").html(secondMenuStr);
    loadJs("webpage/home/contabs.min.js");
    $("#leftMenu>li:first-child").addClass("fixli defactive");//给二级菜单添加默认样式
//		$("#leftMenu>li").on('click',function(){
//			$(this).addClass("fixli defactive").siblings().removeClass("fixli defactive");//给二级菜单去除默认样式
//		});
    $('#leftMenu>li').each(function (i) {
        $(this).hover(function (event) {
            var height = 0;
            for (var j = 0; j < i; j++) {
                height += $('#leftMenu>li').eq(j)[0].offsetHeight;
            }
            appId = $('#leftMenu>li').eq(i)[0].id;
            if (appId && $(".leftDiv li[class='" + appId + "']").length > 0) {
                $(".leftDiv li").css("display", "none");
                $(".leftDiv li[class='" + appId + "']").css("display", "block");
                $('.leftDiv').css('top', 118 + height);
                $(".leftDiv").animate({left: "70"}, 100);
                $('.leftDiv').stop(true, true).slideDown(200);
            }
            event.stopPropagation();
        }, function () {
            $('.leftDiv').stop(true, true).slideUp(200);
        });
    });

    $('.leftDiv').each(function (i) {
        $(this).hover(function (event) {
            $('#leftMenu>li').each(function (i) {
                if ($('#leftMenu>li').eq(i)[0].id == appId) {
                    $('#leftMenu>li').eq(i).css("background-color", "#48b3fe");
                }
            });
            $(this).stop(true, true).show();
        }, function () {
            $('#leftMenu>li').css("background-color", "");
            $(this).stop(true, true).slideUp(200);
        });
    });

}

//显示左侧三级菜单（与地图交互方式）
function showThirdMenu(name, link, hidden) {
	
    $(".page-tabs-content").children("[data-id]").not(":first").each(function() {
        $('.J_iframe[data-id="' + $(this).data("id") + '"]').remove();
        $(this).remove()
    });
    $(".page-tabs-content").children("[data-id]:first").each(function() {
        $('.J_iframe[data-id="' + $(this).data("id") + '"]').show();
        $(this).addClass("active")
    });
    $(".page-tabs-content").css("margin-left", "0");
    
    //layer.closeAll();
    var width = $("#mapDiv").width() * 0.32;
    var height = ($("#mapDiv").height() - 2);
    if (width < 451) {
        width = 450;
    }

    //隐藏弹窗实现，用于初始不需要界面的功能，实现方式是把界面移到屏幕之外
    var left = hidden == "true" ? width * -1 : defaultLeft;

    window.openLayerPanal(link, name, null, width, height, defaultTop, left, false, true, removeMapFun, null);
}

//清除地图相关操作
function removeMapFun() {
    if (GisObject) {
        removeHeatmap();
        removeAllFeatures();
        window.moveAgcomWindowByWidth(0);
    }
}

var flag = 1;

function waistbandFun(o) {
    var isOn = $(o).attr("rel");
    if (isOn == "1") {
        $("#funPannel").removeClass("funPannelOn").addClass("funPannelOff");
        $(o).attr("rel", "-1");
        $(o).find("img").attr("src", "img/menu-slide-down.png");
    } else {
        $("#funPannel").removeClass("funPannelOff").addClass("funPannelOn");
        $(o).attr("rel", "1");
        $(o).find("img").attr("src", "img/menu-slide-up.png");
    }
}

//地图初始化
function initMap() {
    //地图
    var mapFrame = $("#mapDiv");
    mapFrame.attr("src", "/" + agcom_url);
}

//退出系统
function exitSystem() {
    $.ajax({
        type: 'post',
        url: baseUrl + "/" + serverName + "/logout",
        cache: false,
        success: function () {
            $.ajax({
                type: 'post',
                url: "/" + serverName + "/login!logNoCasOut.action",
                cache: false,
                success: function () {
                    window.location.href = baseUrl + "/" + serverName + "/login?service=http%3A%2F%2F" + window.location.hostname + "%3A" + window.location.port + "%2F" + asipui_url + "%2F";
                }
            });
        }
    });
}

//封装动态新增tab函数

//方法一:通过菜单ID新增tab
function createTab(menuId) {
    var menuLen = menuList.length;
    for (var i = 0; i < menuLen; i++) {
        if (menuList[i].id == menuId) {
            var l = menuList[i].name;
            var o = menuList[i].link;
            createNewtab(o, l);
        }
    }
}
//方法二：通过直接传入链接地址新增tab
function createNewtab(o, title) {
    var k = true;
    $(".J_menuTab").each(function () {
        if ($(this).data("id") == o) {
            if (!$(this).hasClass("active")) {
                $(this).addClass("active").siblings(".J_menuTab").removeClass("active");
                $(".J_mainContent .J_iframe").each(function () {
                    if ($(this).data("id") == o) {
                        $(this).show().siblings(".J_iframe").hide();
                        return false
                    }
                })
            }
            k = false;
            return false
        }
    });
    if (k) {
        var p = '<a href="javascript:;" class="active J_menuTab" data-id="' + o + '">' + title + ' <i class="fa fa-times-circle"></i></a>';
        $(".J_menuTab").removeClass("active");
        var n = '<iframe class="J_iframe"  width="100%" height="100%" src="' + o + '" frameborder="0" data-id="' + o + '" seamless></iframe>';
        $(".J_mainContent").find(".J_iframe").hide().parents(".J_mainContent").append(n);
        $(".J_menuTabs .page-tabs-content").append(p);
    }
    return false;
}

//屏幕自适应点击事件
function screenWidth() {
    var wid = $(window).width();
    if (wid <= 1280) {
        $('.tnav').css({
            'margin-right': '0px',    // 清除
            'padding-right': '0px' // 清除

        });
        if (wid <= 980) {
            //初始化为隐藏
            $("#topMenu").hide();
            //点击按钮切换菜单选项
            var onOff = true;
            $("#list").click(function () {
                if (onOff) {
                    $("#topMenu").show();
                    onOff = false;
                } else {
                    $("#topMenu").hide();
                    onOff = true;
                }
            });
        }
    } else if (wid > 1280) {
        $('.tnav').css({
            'margin-right': '20px',    // 清除
            'padding-right': '20px' // 清除

        });
        if (wid > 980) {
            $("#topMenu").show();
        }
    }

}
$(window).resize(function () {
    screenWidth();
});

function getParams(link) {
    if (("" + link).indexOf("javascript") == -1) {
        if (("" + link).indexOf("?") != -1) {
            return "&serverName=" + serverName + "&sde_user=" + sde_user + "&userCode=" + userCode + "&agcom_url=" + agcom_url;
        } else {
            return "?serverName=" + serverName + "&sde_user=" + sde_user + "&userCode=" + userCode + "&agcom_url=" + agcom_url;
        }
    } else {
        return "";
    }
}

function addRecord(type) {
    $.ajax({
        method: 'GET',
        url: '/' + serverName + '/meteo-hydrolog-alarm!listJson.action',
        // async : false,
        dataType: 'json',
        success: function (data) {
            var userType = data.userType;
            if (type != userType) {
                if (type == 1)
                    layer.msg('当前用户无权限启动市级响应预案!');
                else
                    layer.msg('当前用户无权限启动成员单位响应预案!');
                return;
            }
            if (data.cityRecord) {
                //进入调度室
                showDialog(data.cityRecord.id, userType);
            } else if (data.form) {
                //启动预案
                //startYJ(data.form.id,userType);
                if (userType == 1) {
                    showAddYJWindow(data.form.id);
                } else {
                    //其他用户点击，提示
                    layer.msg("当前用户无权限启动市级响应预案");
                }
            } else {
                layer.msg('当前无气象水文预警，不能启动预案!');
            }
        },
        error: function () {
            parent.layer.msg('请求失败');
        }
    });
}

//关闭tab页
function closeNavTab(o) {
    var m = $(this).data("id");
    var l = $(this).width();
    $(".J_menuTab").each(function () {
        if (o.indexOf($(this).data("id")) > -1) {
            if ($(this).hasClass("active")) {
                if ($(this).next().size()) {
                    var k = $(this).next(".J_menuTab:eq(0)").data("id");
                    $(this).next(".J_menuTab:eq(0)").addClass("active");
                    $(this).remove();
                    $(".J_mainContent .J_iframe").each(function () {
                        if ($(this).data("id") == k) {
                            $(this).show().siblings(".J_iframe").hide();
                            return false
                        }
                    });
                    var n = parseInt($(".page-tabs-content").css("margin-left"));
                    if (n < 0) {
                        $(".page-tabs-content").animate({
                                marginLeft: (n + l) + "px"
                            },
                            "fast")
                    }
                    $(this).remove();
                    $(".J_mainContent .J_iframe").each(function () {
                        if ($(this).data("id") == m) {
                            $(this).remove();
                            return false
                        }
                    })
                }
                if ($(this).prev(".J_menuTab").size()) {
                    var k = $(this).prev(".J_menuTab:last").data("id");
                    $(this).prev(".J_menuTab:last").addClass("active");
                    $(".J_mainContent .J_iframe").each(function () {
                        if ($(this).data("id") == k) {
                            $(this).show().siblings(".J_iframe").hide();
                            return false
                        }
                    });
                    $(this).remove();
                    $(".J_mainContent .J_iframe").each(function () {
                        if ($(this).data("id") == m) {
                            $(this).remove();
                            return false
                        }
                    })
                }
            } else {
                $(this).remove();
                $(".J_mainContent .J_iframe").each(function () {
                    if ($(this).data("id") == m) {
                        $(this).remove();
                        return false
                    }
                });
            }
            return false;
        }
    });
}